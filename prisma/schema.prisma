generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name           String
  type           TenantType
  status         TenantStatus
  created_at     DateTime       @default(now()) @db.Timestamptz(6)
  form_templates FormTemplate[]
  planner_tasks  PlannerTask[]
}

model User {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String        @unique
  name          String
  role          UserRole
  tenant_id     String        @db.Uuid
  status        UserStatus
  planner_tasks PlannerTask[]
}

model Patient {
  id               String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id        String           @db.Uuid
  user_id          String?          @unique @db.Uuid
  assigned_team_id String?          @db.Uuid
  status           PatientStatus
  created_at       DateTime         @default(now()) @db.Timestamptz(6)
  enabled_modules  Json?
  form_submissions FormSubmission[]
}

model PatientProfile {
  id                String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id         String        @db.Uuid
  patient_id        String        @unique @db.Uuid
  sex               BiologicalSex
  birth_date        DateTime      @db.Timestamptz(6)
  height_cm         Decimal       @db.Decimal
  current_weight_kg Decimal       @db.Decimal
  target_weight_kg  Decimal?      @db.Decimal
  activity_level    ActivityLevel
  goal              Goal
}

model PatientCondition {
  id         String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id  String        @db.Uuid
  patient_id String        @db.Uuid
  type       ConditionType
  name       String
  severity   Severity
  notes      String?
}

model SymptomLog {
  id               String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id        String        @db.Uuid
  patient_id       String        @db.Uuid
  logged_at        DateTime      @default(now()) @db.Timestamptz(6)
  bristol_scale    BristolScale?
  discomfort_level Int?
  symptoms         SymptomType[]
  notes            String?
  created_at       DateTime      @default(now()) @db.Timestamptz(6)

  @@index([patient_id, logged_at])
}

model SymptomMealCorrelation {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id         String   @db.Uuid
  symptom_log_id    String   @db.Uuid
  meal_id           String   @db.Uuid
  correlation_score Decimal? @db.Decimal
  notes             String?
  is_flagged        Boolean  @default(false)
  created_at        DateTime @default(now()) @db.Timestamptz(6)

  @@unique([symptom_log_id, meal_id])
}

model Consultation {
  id         String   @id @default(uuid())
  tenant_id  String
  patient_id String
  status     String
  notes      String?
  created_at DateTime @default(now())
}

model Protocol {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id   String       @db.Uuid
  name        String
  description String?
  is_active   Boolean      @default(true)
  created_at  DateTime     @default(now()) @db.Timestamptz(6)
  code        String
  is_system   Boolean      @default(false)
  type        ProtocolType

  @@unique([tenant_id, code])
}

model ProtocolPhase {
  id           String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  protocol_id  String            @db.Uuid
  phase_type   ProtocolPhaseType
  name         String
  description  String?
  order        Int
  default_days Int?
  rules_json   Json?
  created_at   DateTime          @default(now()) @db.Timestamptz(6)

  @@unique([protocol_id, order])
}

model ProtocolFoodTag {
  id         String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  phase_id   String        @db.Uuid
  food_group FoodGroup
  tag        String
  action     FoodTagAction
  notes      String?
  created_at DateTime      @default(now()) @db.Timestamptz(6)

  @@unique([phase_id, food_group, tag])
}

model PatientProtocolInstance {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id   String    @db.Uuid
  patient_id  String    @db.Uuid
  protocol_id String    @db.Uuid
  started_at  DateTime  @default(now()) @db.Timestamptz(6)
  ended_at    DateTime? @db.Timestamptz(6)
  is_active   Boolean   @default(true)
  notes       String?
  created_by  String    @db.Uuid
  created_at  DateTime  @default(now()) @db.Timestamptz(6)

  @@index([patient_id, is_active])
}

model PatientProtocolPhase {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  instance_id     String    @db.Uuid
  phase_id        String    @db.Uuid
  started_at      DateTime  @default(now()) @db.Timestamptz(6)
  ended_at        DateTime? @db.Timestamptz(6)
  is_current      Boolean   @default(true)
  transition_note String?
  created_at      DateTime  @default(now()) @db.Timestamptz(6)

  @@index([instance_id, is_current])
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model FoodCanonical {
  id         String    @id @default(uuid())
  tenant_id  String
  name       String
  group      FoodGroup
  region_tag RegionTag
  is_generic Boolean
  created_at DateTime  @default(now())
}

model Recipe {
  id                       String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                String         @db.Uuid
  name                     String
  description              String?
  instructions             String?
  prep_time_min            Int?
  cook_time_min            Int?
  servings                 Int            @default(1)
  is_public                Boolean        @default(false)
  is_favorite              Boolean        @default(false)
  tags                     String[]
  created_by               String         @db.Uuid
  created_at               DateTime       @default(now()) @db.Timestamptz(6)
  updated_at               DateTime       @default(now()) @updatedAt @db.Timestamptz(6)
  is_calculated            Boolean        @default(false)
  unit_type                RecipeUnitType @default(solid)
  final_weight             Decimal?
  household_measure_label  String?
  household_measure_amount Decimal?
  generated_description    String?

  @@index([tenant_id, is_public])
  @@index([tenant_id, is_favorite])
}

model RecipeIngredient {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  recipe_id  String   @db.Uuid
  food_id    String   @db.Uuid
  grams      Decimal  @db.Decimal
  notes      String?
  order      Int      @default(0)
  created_at DateTime @default(now()) @db.Timestamptz(6)

  @@unique([recipe_id, food_id])
}

model FoodSubstitution {
  id                 String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id          String           @db.Uuid
  original_food_id   String           @db.Uuid
  substitute_food_id String           @db.Uuid
  substitution_type  SubstitutionType
  ratio              Decimal          @default(1.0) @db.Decimal
  notes              String?
  is_verified        Boolean          @default(false)
  created_by         String           @db.Uuid
  created_at         DateTime         @default(now()) @db.Timestamptz(6)

  @@unique([tenant_id, original_food_id, substitute_food_id, substitution_type])
  @@index([tenant_id, substitution_type])
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model FoodAlias {
  id         String   @id @default(uuid())
  tenant_id  String
  food_id    String
  alias      String
  locale     String
  created_at DateTime @default(now())
}

model FoodNutrient {
  tenant_id          String
  food_id            String
  nutrient_key       NutrientKey
  per_100g_value     Decimal
  unit               String
  source             String
  dataset_release_id String
  quality_flag       QualityFlag

  @@id([tenant_id, food_id, nutrient_key, dataset_release_id])
  @@index([food_id, dataset_release_id, nutrient_key], map: "idx_food_nutrient_policy")
}

model DatasetRelease {
  id            String        @id @default(uuid())
  tenant_id     String
  region        Region
  source_name   String
  version_label String
  published_at  DateTime?
  status        ReleaseStatus
  created_at    DateTime      @default(now())
}

model ImportJob {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id          String    @db.Uuid
  dataset_release_id String?   @db.Uuid
  source_label       String
  status             String
  created_at         DateTime  @default(now()) @db.Timestamptz(6)
  completed_at       DateTime? @db.Timestamptz(6)
}

model ValidationReport {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id          String   @db.Uuid
  dataset_release_id String   @db.Uuid
  status             String
  details_json       Json
  created_at         DateTime @default(now()) @db.Timestamptz(6)
}

model PatientDataPolicy {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id       String   @db.Uuid
  patient_id      String   @db.Uuid
  version_number  Int
  is_active       Boolean  @default(true)
  default_region  Region
  allowed_sources Json
  rules_json      Json?
  notes           String?
  updated_by      String   @db.Uuid
  created_at      DateTime @default(now()) @db.Timestamptz(6)

  @@unique([patient_id, version_number])
}

model PatientCategoryOverride {
  id               String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  policy_id        String  @db.Uuid
  category_code    String
  preferred_source String
  notes            String?

  @@unique([policy_id, category_code])
}

model FoodSnapshot {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id          String   @db.Uuid
  patient_id         String   @db.Uuid
  food_id            String   @db.Uuid
  snapshot_json      Json
  source             String
  dataset_release_id String   @db.Uuid
  content_hash       String?  @default(dbgenerated("md5((snapshot_json)::text)"))
  created_at         DateTime @default(now()) @db.Timestamptz(6)
}

model Meal {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id   String   @db.Uuid
  patient_id  String   @db.Uuid
  date        DateTime @db.Timestamptz(6)
  type        MealType
  totals_json Json?
  created_at  DateTime @default(now()) @db.Timestamptz(6)

  @@index([patient_id, date], map: "idx_patient_date")
}

model MealItem {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id   String   @db.Uuid
  meal_id     String   @db.Uuid
  food_id     String   @db.Uuid
  grams       Decimal  @db.Decimal
  snapshot_id String   @db.Uuid
  created_at  DateTime @default(now()) @db.Timestamptz(6)
}

model PlanTemplate {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id   String       @db.Uuid
  name        String
  description String?
  goal        TemplateGoal
  target_kcal Int?
  macro_split Json?
  is_public   Boolean      @default(false)
  is_system   Boolean      @default(false)
  tags        String[]
  created_by  String       @db.Uuid
  created_at  DateTime     @default(now()) @db.Timestamptz(6)
  updated_at  DateTime     @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([tenant_id, is_public])
  @@index([tenant_id, goal])
}

model PlanTemplateItem {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  template_id     String   @db.Uuid
  meal_type       MealType
  food_id         String?  @db.Uuid
  placeholder     String?
  grams           Decimal? @db.Decimal
  percentage_kcal Decimal? @db.Decimal
  instructions    String?
  order           Int      @default(0)
  created_at      DateTime @default(now()) @db.Timestamptz(6)

  @@index([template_id, meal_type])
}

model Plan {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id   String     @db.Uuid
  patient_id  String     @db.Uuid
  status      PlanStatus
  created_at  DateTime   @default(now()) @db.Timestamptz(6)
  template_id String?    @db.Uuid
}

model PlanVersion {
  id         String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id  String        @db.Uuid
  plan_id    String        @db.Uuid
  version_no Int
  status     VersionStatus
  created_by String        @db.Uuid
  created_at DateTime      @default(now()) @db.Timestamptz(6)
  updated_at DateTime      @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([plan_id, version_no])
}

model PlanItem {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id       String   @db.Uuid
  plan_version_id String   @db.Uuid
  meal_type       MealType
  food_id         String   @db.Uuid
  grams           Decimal  @db.Decimal
  snapshot_id     String   @db.Uuid
  instructions    String?
}

model PlanApproval {
  plan_version_id String   @id @db.Uuid
  tenant_id       String   @db.Uuid
  approved_by     String   @db.Uuid
  approved_at     DateTime @db.Timestamptz(6)
  approval_note   String?
}

model PlanPublication {
  plan_version_id String   @id @db.Uuid
  tenant_id       String   @db.Uuid
  published_by    String   @db.Uuid
  published_at    DateTime @db.Timestamptz(6)
}

model AuditEvent {
  id            String      @id @default(uuid())
  tenant_id     String
  actor_user_id String
  actor_role    UserRole
  action        AuditAction
  entity_type   String
  entity_id     String
  before_json   Json?
  after_json    Json?
  reason        String?
  request_id    String
  ip_hash       String?
  user_agent    String?
  created_at    DateTime    @default(now())

  @@index([created_at], map: "idx_audit_event_created_at")
  @@index([tenant_id, entity_type, entity_id], map: "idx_audit_event_entity")
}

model CalcAudit {
  id                 String   @id @default(uuid())
  tenant_id          String
  patient_id         String?
  calc_type          CalcType
  inputs_json        Json
  params_json        Json
  output_json        Json
  rounding_policy    String
  units_version      String
  dataset_release_id String?
  created_by         String
  created_at         DateTime @default(now())
  override_note      String?

  @@index([created_at], map: "idx_calc_audit_created_at")
  @@index([tenant_id, patient_id], map: "idx_calc_audit_tenant_patient")
}

model IntegrityCheckRun {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String      @db.Uuid
  run_type     String
  started_at   DateTime    @db.Timestamptz(6)
  finished_at  DateTime?   @db.Timestamptz(6)
  status       CheckStatus
  summary_json Json?
}

model IntegrityIssue {
  id           String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String        @db.Uuid
  run_id       String        @db.Uuid
  severity     IssueSeverity
  entity_type  String
  entity_id    String?
  details_json Json
  created_at   DateTime      @default(now()) @db.Timestamptz(6)
  resolved_at  DateTime?     @db.Timestamptz(6)
}

model PlannerTask {
  id          String       @id @default(uuid()) @db.Uuid
  tenant_id   String       @db.Uuid
  user_id     String       @db.Uuid
  title       String
  description String?
  status      TaskStatus   @default(todo)
  priority    TaskPriority @default(medium)
  due_date    DateTime?
  created_at  DateTime     @default(now())
  updated_at  DateTime     @default(now()) @updatedAt
  tenant      Tenant       @relation(fields: [tenant_id], references: [id])
  user        User         @relation(fields: [user_id], references: [id])

  @@index([tenant_id, user_id])
}

model FormTemplate {
  id             String           @id @default(uuid()) @db.Uuid
  tenant_id      String           @db.Uuid
  title          String
  type           FormType         @default(custom)
  structure_json Json
  is_system      Boolean          @default(false)
  created_at     DateTime         @default(now())
  updated_at     DateTime         @default(now()) @updatedAt
  submissions    FormSubmission[]
  tenant         Tenant           @relation(fields: [tenant_id], references: [id])

  @@index([tenant_id, type])
}

model FormSubmission {
  id             String       @id @default(uuid()) @db.Uuid
  template_id    String       @db.Uuid
  patient_id     String       @db.Uuid
  responses_json Json
  submitted_at   DateTime     @default(now())
  patient        Patient      @relation(fields: [patient_id], references: [id])
  template       FormTemplate @relation(fields: [template_id], references: [id])

  @@index([patient_id, template_id])
}

enum TenantType {
  B2C
  B2B
}

enum TenantStatus {
  active
  suspended
  archived
}

enum UserRole {
  OWNER
  TENANT_ADMIN
  TEAM
  PATIENT
}

enum UserStatus {
  active
  inactive
}

enum PatientStatus {
  active
  inactive
  archived
}

enum BiologicalSex {
  male
  female
}

enum ActivityLevel {
  sedentary
  light
  moderate
  very_active
  extra_active
}

enum Goal {
  maintain
  loss
  gain
}

enum ConditionType {
  allergy
  intolerance
  disease
  other
}

enum Severity {
  low
  medium
  high
}

enum FoodGroup {
  grains
  dairy
  protein
  fruits
  vegetables
  legumes
  oils
  sweets
  beverages
  other
}

enum RegionTag {
  BR
  DE
  GLOBAL
}

enum Region {
  BR
  DE
  MIXED
  US
}

enum NutrientKey {
  energy_kcal
  protein_g
  carbs_g
  fat_g
  fiber_g
}

enum QualityFlag {
  verified
  estimated
  incomplete
}

enum ReleaseStatus {
  draft
  validated
  published
  archived
}

enum MealType {
  breakfast
  lunch
  dinner
  snack
}

enum PlanStatus {
  active
  archived
}

enum VersionStatus {
  draft
  reviewed
  approved
  published
  archived
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE_SOFT
  APPROVE
  PUBLISH
  ARCHIVE
  POLICY_CHANGE
  SNAPSHOT_CREATE
  DATASET_PUBLISH
  LOGIN
  SUPPORT_ACCESS
}

enum CalcType {
  TMB
  TDEE
  MEAL_TOTAL
  DAY_TOTAL
  PLAN_TOTAL
}

enum CheckStatus {
  running
  passed
  failed
}

enum IssueSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TaskStatus {
  todo
  in_progress
  done
}

enum TaskPriority {
  low
  medium
  high
}

enum RecipeUnitType {
  solid
  liquid
}

enum FormType {
  system
  custom
}

enum BristolScale {
  type_1
  type_2
  type_3
  type_4
  type_5
  type_6
  type_7
}

enum SymptomType {
  gas
  bloating
  abdominal_pain
  nausea
  reflux
  diarrhea
  constipation
  cramping
  fatigue
  headache
  other
}

enum ProtocolType {
  FODMAP
  LACTOSE
  GLUTEN
  CONSTIPATION
  REFLUX
  DIARRHEA
  CUSTOM
}

enum ProtocolPhaseType {
  elimination
  reintroduction
  maintenance
  custom
}

enum FoodTagAction {
  allowed
  avoid
  caution
}

enum SubstitutionType {
  isocaloric
  isoproteic
  low_fodmap
  lactose_free
  gluten_free
  general
}

enum TemplateGoal {
  loss
  gain
  maintain
  protocol_fodmap
  protocol_lactose
  protocol_gluten
  custom
}
